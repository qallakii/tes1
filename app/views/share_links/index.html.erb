<div class="dashboard-page">

  <% if @share_links.any? %>
    <div class="drive-card">
      <div class="drive-scroll">
        <div class="drive-list share-links-list">

          <div class="drive-header">
            <div class="col-folder">Folders</div>
            <div class="col-url">Share link</div>
            <div class="col-expires">Expires</div>
            <div class="col-created">Created</div>
            <div class="col-actions">Actions</div>
          </div>

          <% @share_links.each do |link| %>
            <% folders = link.respond_to?(:all_folders) ? link.all_folders : [] %>
            <% first_folder = folders.first || link.folder %>
            <% folder_count = folders.size %>
            <% share_url = public_share_url(link.token) %>

            <div class="drive-row share-row">
              <div class="col-folder">
                <% if first_folder %>
                  <%= link_to folder_path(first_folder), class: "folder-link" do %>
                    <span class="folder-icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                      </svg>
                    </span>
                    <span class="folder-name">
                      <%= first_folder.name %>
                      <% if folder_count > 1 %>
                        <span class="muted" style="font-weight:500;">(+<%= folder_count - 1 %>)</span>
                      <% end %>
                    </span>
                  <% end %>
                <% else %>
                  <span class="muted">No folder</span>
                <% end %>
              </div>

              <div class="col-url">
                <div class="url-line">
                  <a class="url-text" href="<%= share_url %>" target="_blank" rel="noopener"><%= share_url %></a>
                </div>
              </div>

              <div class="col-expires">
                <span class="muted">
                  <% if link.expires_at.nil? %>
                    Never
                  <% elsif link.expires_at < Time.current %>
                    Expired
                  <% else %>
                    <%= link.expires_at.strftime("%b %d, %Y %H:%M") %>
                  <% end %>
                </span>
              </div>

              <div class="col-created">
                <span class="muted"><%= link.created_at.strftime("%b %d, %Y %H:%M") %></span>
              </div>

              <div class="col-actions">
                <div class="action-group">
                  <button type="button" class="btn secondary xsmall copy-btn" data-copy="<%= share_url %>">Copy</button>

                  <%= link_to "Open",
                    public_share_path(link.token),
                    target: "_blank",
                    rel: "noopener",
                    class: "btn secondary xsmall" %>



                  <%= button_to "Delete",
                    share_link_path(link),
                    method: :delete,
                    data: { confirm: "Delete this share link?" },
                    class: "btn secondary xsmall",
                    form: { class: "inline-form" } %>
                </div>
              </div>
            </div>
          <% end %>

        </div>
      </div>
    </div>
  <% else %>
    <div class="drive-card" style="padding:16px;">
      <div class="muted">No share links yet.</div>
    </div>
  <% end %>

</div>

<style>
  .share-links-list { min-width: 980px; }

  .share-links-list .drive-header,
  .share-links-list .drive-row{
    display:grid;
    grid-template-columns: 220px 380px 150px 150px 190px;
    gap: 12px;
    padding: 10px 14px;
    align-items:center;
    font-size: 13px;
    line-height: 1.35;
  }

  .share-links-list .drive-header{
    font-size: 11.5px;
    font-weight: 600;
    letter-spacing: 0.02em;
    background: rgba(0,0,0,0.02);
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }

  .share-row{
    border-bottom: 1px solid rgba(0,0,0,0.06);
    transition: background 0.15s ease;
  }
  .share-row:hover{ background: rgba(0,0,0,0.02); }

  .folder-link{ display:flex; align-items:center; gap:10px; min-width:0; }
  .folder-icon{ opacity:0.85; display:flex; }
  .folder-name{
    font-weight:600;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    min-width:0;
  }

  .url-line{ min-width:0; }
  .url-text{
    display:block;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    color:#2563eb;
    font-size: 12.5px;
  }
  .url-text:hover{ text-decoration: underline; }

  .action-group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .inline-form { display:inline-block; margin:0; }
  .btn.xsmall { padding: 5px 9px; border-radius: 10px; line-height: 1; font-size: 12px; }
</style>

<script>
  function initShareLinksIndex() {
    document.querySelectorAll(".copy-btn").forEach((btn) => {
      if (btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";

      btn.addEventListener("click", async () => {
        const text = btn.getAttribute("data-copy");
        try {
          await navigator.clipboard.writeText(text);
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
        const old = btn.textContent;
        btn.textContent = "Copied";
        setTimeout(() => (btn.textContent = old), 900);
      });
    });
  }

  document.addEventListener("turbo:load", initShareLinksIndex);
  document.addEventListener("DOMContentLoaded", initShareLinksIndex);
</script>
