<div class="dashboard-page">

  <div class="drive-page-head">
    <div class="drive-head-left">
      <h1 style="margin:0;">Shared Links</h1>
      <div class="muted" style="margin-top:4px; margin-bottom:8px;">Links you created for sharing</div>
    </div>

    <div class="drive-head-right" style="margin-bottom:8px;">
      <%= link_to "Create link", new_share_link_path, class: "btn primary" %>
    </div>
  </div>

  <% if @share_links.any? %>
    <div class="drive-card">
      <div class="drive-scroll">
        <div class="drive-list share-links-list">

          <div class="drive-header">
            <div class="col-folder">Folder</div>
            <div class="col-url">Share link</div>
            <div class="col-expires">Expires</div>
            <div class="col-created">Created</div>
            <div class="col-actions">Actions</div>
          </div>

          <% @share_links.each do |link| %>
            <% url = share_link_url(link.token) %>

            <div class="drive-row share-row">
              <div class="col-folder">
                <%= link_to folder_path(link.folder), class: "folder-link" do %>
                  <span class="folder-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    </svg>
                  </span>
                  <span class="folder-name"><%= link.folder.name %></span>
                <% end %>
              </div>

              <div class="col-url">
                <div class="url-line">
                  <a class="url-text" href="<%= url %>" target="_blank" rel="noopener"><%= url %></a>
                </div>
              </div>

              <div class="col-expires">
                <span class="muted">
                  <% if link.expires_at.nil? %>
                    Never
                  <% elsif link.expires_at < Time.current %>
                    Expired
                  <% else %>
                    <%= link.expires_at.strftime("%b %d, %Y %H:%M") %>
                  <% end %>
                </span>
              </div>

              <div class="col-created">
                <span class="muted"><%= link.created_at.strftime("%b %d, %Y %H:%M") %></span>
              </div>

              <div class="col-actions">
                <div class="action-group">
                  <button
                    type="button"
                    class="btn secondary xsmall copy-btn"
                    data-copy="<%= url %>">
                    Copy
                  </button>

                  <%= link_to "Open",
                    share_link_path(link.token),
                    target: "_blank",
                    rel: "noopener",
                    class: "btn secondary xsmall" %>

                  <%= button_to "Delete",
                    share_link_path(link),
                    method: :delete,
                    data: { confirm: "Delete this share link?" },
                    class: "btn secondary xsmall",
                    form: { class: "inline-form" } %>
                </div>
              </div>
            </div>
          <% end %>

        </div>
      </div>
    </div>

  <% else %>
    <div class="drive-card" style="padding:16px;">
      <div class="muted">No share links yet. Create one from a folder, or click “Create link”.</div>
    </div>
  <% end %>

</div>

<style>
  .share-links-list { min-width: 620px; }

  .share-links-list .drive-header,
  .share-links-list .drive-row{
    display:grid;
    grid-template-columns: minmax(220px, 1fr) minmax(260px, 1.4fr) 190px 190px 320px;
    gap: 12px;
    padding: 10px 14px;
    align-items:center;
    font-size: 13px;
    line-height: 1.35;
  }

  .folder-link{ display:flex; align-items:center; gap:10px; }
  .folder-icon{ opacity:0.85; display:flex; }
  .folder-name{ font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .url-line{ min-width:0; }
  .url-text{
    display:block;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    color:#2563eb;
    font-size: 12.5px;
  }
  .url-text:hover{ text-decoration: underline; }

  .inline-form { display:inline-block; margin:0; }
  .action-group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn.xsmall { padding: 5px 9px; border-radius: 10px; line-height: 1; font-size: 12px; }
</style>

<script>
  function initShareLinksIndex() {
    document.querySelectorAll(".copy-btn").forEach((btn) => {
      if (btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";

      btn.addEventListener("click", async () => {
        const text = btn.getAttribute("data-copy");
        try {
          await navigator.clipboard.writeText(text);
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
        const old = btn.textContent;
        btn.textContent = "Copied";
        setTimeout(() => (btn.textContent = old), 900);
      });
    });
  }

  document.addEventListener("turbo:load", initShareLinksIndex);
  document.addEventListener("DOMContentLoaded", initShareLinksIndex);
</script>
