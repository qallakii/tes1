<div class="dashboard-page">

  <% share_url = public_share_url(@share_link.token) %>
  <% folders = (@folders.presence || []).to_a %>
  <% selected_folder = @folder %>
  <% direct_files = defined?(@direct_cvs) ? @direct_cvs : [] %>
  <% mixed = direct_files.any? && folders.any? %>

  <div class="share-hero">
    <div class="share-hero-left">
      <div class="share-badges">
        <span class="badge">
          <% if @files_only %>
            Shared files
          <% elsif folders.size > 1 %>
            Shared folders
          <% else %>
            Shared folder
          <% end %>
        </span>

        <% if @share_link.expires_at.nil? %>
          <span class="badge neutral">Expires: Never</span>
        <% elsif @share_link.expires_at < Time.current %>
          <span class="badge danger">Expired</span>
        <% else %>
          <span class="badge neutral">Expires: <%= @share_link.expires_at.strftime("%b %d, %Y %H:%M") %></span>
        <% end %>
      </div>

      <h1 class="share-title">
        <% if @files_only %>
          Shared files
        <% elsif selected_folder %>
          <%= selected_folder.name %>
        <% else %>
          Shared folders
        <% end %>
      </h1>

      <div class="share-sub muted">
        <% if @files_only %>
          Only the selected files are visible here.
        <% elsif selected_folder %>
          You can preview files in a new tab and download them.
        <% else %>
          Click a folder to view the files inside.
        <% end %>
      </div>
    </div>

    <div class="share-hero-right">
      <button type="button" class="btn secondary copy-btn" data-copy="<%= share_url %>">Copy link</button>
      <a class="btn primary" href="<%= share_url %>" target="_blank" rel="noopener">Open</a>
      <% unless current_user %>
        <%= link_to "Login", login_path, class: "btn secondary" %>
      <% end %>
    </div>
  </div>

  <%# ====== FOLDERS LIST (click anywhere) ====== %>
  <% unless selected_folder || @files_only %>
    <div class="drive-card" style="margin-bottom:12px;">
      <div class="drive-scroll">
        <div class="drive-list folders-pick-list" style="min-width:720px;">
          <div class="drive-header folders-pick-header">
            <div>Folder</div>
            <div style="text-align:right;">Action</div>
          </div>

          <% folders.each do |f| %>
            <% open_url = public_share_path(@share_link.token, folder_id: f.id) %>
            <div class="drive-row folder-pick-row clickable-folder-row" data-open="<%= open_url %>">
              <div class="folder-cell">
                <span class="folder-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  </svg>
                </span>
                <div class="folder-name"><%= f.name %></div>
              </div>

              <div style="text-align:right;">
                <%= link_to "Open", open_url, class: "btn secondary xsmall" %>
              </div>
            </div>
          <% end %>

          <% if folders.empty? %>
            <div style="padding:16px;" class="muted">No folders found in this share link.</div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# ====== FILES ONLY MODE ====== %>
  <% if @files_only %>
    <% if @cvs.any? %>
      <div class="drive-card">
        <div class="drive-scroll">
          <div class="drive-list shared-files-list">

            <div class="drive-header">
              <div class="col-name">Name</div>
              <div class="col-type">Type</div>
              <div class="col-size">Size</div>
              <div class="col-modified">Last modified</div>
              <div class="col-actions">Actions</div>
            </div>

            <% @cvs.each do |cv| %>
              <% blob = cv.file&.blob %>
              <% display_name = cv.title.presence || cv.file.filename.to_s %>
              <% ext = cv.file.filename.extension.to_s.upcase %>
              <% type_label = ext.present? ? ext : "PDF" %>
              <% size_bytes = blob&.byte_size.to_i %>

             <% preview_url  = file_preview_share_link_path(@share_link, cv_id: cv.id) %>
             <% download_url = file_download_share_link_path(@share_link, cv_id: cv.id) %>


              <div class="drive-row shared-row clickable-row" data-preview="<%= preview_url || "" %>">
                <div class="col-name">
                  <div class="file-line">
                    <span class="file-icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6"/>
                      </svg>
                    </span>

                    <div class="file-text">
                      <div class="file-name"><%= display_name %></div>
                      <div class="file-sub"><%= cv.file.filename %></div>
                    </div>
                  </div>
                </div>

                <div class="col-type"><span class="pill"><%= type_label %></span></div>

                <div class="col-size">
                  <span class="muted size-num" data-size-text><%= size_bytes %></span>
                </div>

                <div class="col-modified">
                  <span class="muted"><%= cv.updated_at.strftime("%b %d, %Y %H:%M") %></span>
                </div>

                <div class="col-actions">
                  <div class="action-group">
                    <% if @share_link.allow_preview? && preview_url %>
                        <a class="btn secondary xsmall" href="<%= preview_url %>" target="_blank" rel="noopener">Preview</a>
                      <% end %>

                      <% if @share_link.allow_download? && download_url %>
                        <a class="btn secondary xsmall" href="<%= download_url %>">Download</a>
                      <% end %>
                  </div>
                </div>
              </div>
            <% end %>

          </div>
        </div>
      </div>
    <% else %>
      <div class="drive-card" style="padding:16px;">
        <div class="muted">No files found in this share link.</div>
      </div>
    <% end %>
  <% end %>

  <%# ====== SELECTED FOLDER VIEW (ONLY ONE) ====== %>
  <% if selected_folder %>
    <div class="folder-sticky-bar">
      <div class="folder-sticky-left">
        <span class="folder-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          </svg>
        </span>
        <div style="font-weight:800;"><%= selected_folder.name %></div>
      </div>
      <div class="folder-sticky-right">
        <%= link_to "Back to folders", public_share_path(@share_link.token), class: "btn secondary" %>
      </div>
      <%# ====== DIRECTLY SHARED FILES (for mixed shares) ====== %>
      <% if defined?(@direct_cvs) && @direct_cvs.any? && !@files_only %>
        <div class="drive-card" style="margin-bottom:12px;">
          <div class="drive-scroll">
            <div class="drive-list shared-files-list">

              <div class="drive-header">
                <div class="col-name">Directly shared files</div>
                <div class="col-type">Type</div>
                <div class="col-size">Size</div>
                <div class="col-modified">Last modified</div>
                <div class="col-actions">Actions</div>
              </div>

              <% @direct_cvs.each do |cv| %>
                <% blob = cv.file&.blob %>
                <% display_name = cv.title.presence || cv.file.filename.to_s %>
                <% ext = cv.file.filename.extension.to_s.upcase %>
                <% type_label = ext.present? ? ext : "PDF" %>
                <% size_bytes = blob&.byte_size.to_i %>

                <% preview_url  = @share_link.allow_preview?  ? file_preview_share_link_path(@share_link, cv_id: cv.id) : nil %>
                <% download_url = @share_link.allow_download? ? file_download_share_link_path(@share_link, cv_id: cv.id) : nil %>

                <div class="drive-row shared-row clickable-row" data-preview="<%= preview_url || "" %>">
                  <div class="col-name">
                    <div class="file-line">
                      <span class="file-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                          <path d="M14 2v6h6"/>
                        </svg>
                      </span>

                      <div class="file-text">
                        <div class="file-name"><%= display_name %></div>
                        <div class="file-sub"><%= cv.file.filename %></div>
                      </div>
                    </div>
                  </div>

                  <div class="col-type"><span class="pill"><%= type_label %></span></div>

                  <div class="col-size">
                    <span class="muted size-num" data-size-text><%= size_bytes %></span>
                  </div>

                  <div class="col-modified">
                    <span class="muted"><%= cv.updated_at.strftime("%b %d, %Y %H:%M") %></span>
                  </div>

                  <div class="col-actions">
                    <div class="action-group">
                      <% if @share_link.allow_preview? && preview_url.present? %>
                        <a class="btn secondary xsmall" href="<%= preview_url %>" target="_blank" rel="noopener">Preview</a>
                      <% end %>

                      <% if @share_link.allow_download? && download_url.present? %>
                        <a class="btn secondary xsmall" href="<%= download_url %>">Download</a>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>

            </div>
          </div>
        </div>
      <% end %>

    </div>

    <%# ====== DIRECTLY SHARED FILES (for mixed shares) ====== %>
    <% if defined?(@direct_cvs) && @direct_cvs.any? && !@files_only %>
      <div class="drive-card" style="margin-bottom:12px;">
        <div class="drive-scroll">
          <div class="drive-list shared-files-list">

            <div class="drive-header">
              <div class="col-name">Directly shared files</div>
              <div class="col-type">Type</div>
              <div class="col-size">Size</div>
              <div class="col-modified">Last modified</div>
              <div class="col-actions">Actions</div>
            </div>

            <% @direct_cvs.each do |cv| %>
              <% blob = cv.file&.blob %>
              <% display_name = cv.title.presence || cv.file.filename.to_s %>
              <% ext = cv.file.filename.extension.to_s.upcase %>
              <% type_label = ext.present? ? ext : "PDF" %>
              <% size_bytes = blob&.byte_size.to_i %>

              <% preview_url  = @share_link.allow_preview?  ? file_preview_share_link_path(@share_link, cv_id: cv.id) : nil %>
              <% download_url = @share_link.allow_download? ? file_download_share_link_path(@share_link, cv_id: cv.id) : nil %>

              <div class="drive-row shared-row clickable-row" data-preview="<%= preview_url || "" %>">
                <div class="col-name">
                  <div class="file-line">
                    <span class="file-icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6"/>
                      </svg>
                    </span>

                    <div class="file-text">
                      <div class="file-name"><%= display_name %></div>
                      <div class="file-sub"><%= cv.file.filename %></div>
                    </div>
                  </div>
                </div>

                <div class="col-type"><span class="pill"><%= type_label %></span></div>

                <div class="col-size">
                  <span class="muted size-num" data-size-text><%= size_bytes %></span>
                </div>

                <div class="col-modified">
                  <span class="muted"><%= cv.updated_at.strftime("%b %d, %Y %H:%M") %></span>
                </div>

                <div class="col-actions">
                  <div class="action-group">
                    <% if @share_link.allow_preview? && preview_url.present? %>
                      <a class="btn secondary xsmall" href="<%= preview_url %>" target="_blank" rel="noopener">Preview</a>
                    <% end %>

                    <% if @share_link.allow_download? && download_url.present? %>
                      <a class="btn secondary xsmall" href="<%= download_url %>">Download</a>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>

          </div>
        </div>
      </div>
    <% end %>


    <% if @subfolders.any? %>
      <div class="drive-card" style="margin-bottom:12px;">
        <div class="drive-scroll">
          <div class="drive-list folders-pick-list" style="min-width:720px;">
            <div class="drive-header folders-pick-header">
              <div>Subfolder</div>
              <div style="text-align:right;">Action</div>
            </div>

            <% @subfolders.each do |sf| %>
              <% open_url = public_share_path(@share_link.token, folder_id: sf.id) %>
              <div class="drive-row folder-pick-row clickable-folder-row" data-open="<%= open_url %>">
                <div class="folder-cell">
                  <span class="folder-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    </svg>
                  </span>
                  <div class="folder-name"><%= sf.name %></div>
                </div>

                <div style="text-align:right;">
                  <%= link_to "Open", open_url, class: "btn secondary xsmall" %>
                </div>
              </div>
            <% end %>

          </div>
        </div>
      </div>
    <% end %>


    <% if @cvs.any? %>
      <div class="drive-card">
        <div class="drive-scroll">
          <div class="drive-list shared-files-list">

            <div class="drive-header">
              <div class="col-name">Name</div>
              <div class="col-type">Type</div>
              <div class="col-size">Size</div>
              <div class="col-modified">Last modified</div>
              <div class="col-actions">Actions</div>
            </div>

            <% @cvs.each do |cv| %>
              <% blob = cv.file&.blob %>
              <% display_name = cv.title.presence || cv.file.filename.to_s %>
              <% ext = cv.file.filename.extension.to_s.upcase %>
              <% type_label = ext.present? ? ext : "PDF" %>
              <% size_bytes = blob&.byte_size.to_i %>

              <% preview_url  = @share_link.allow_preview?  ? file_preview_share_link_path(@share_link, cv_id: cv.id) : nil %>
              <% download_url = @share_link.allow_download? ? file_download_share_link_path(@share_link, cv_id: cv.id) : nil %>

              <div class="drive-row shared-row clickable-row" data-preview="<%= preview_url || "" %>">
                <div class="col-name">
                  <div class="file-line">
                    <span class="file-icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6"/>
                      </svg>
                    </span>

                    <div class="file-text">
                      <div class="file-name"><%= display_name %></div>
                      <div class="file-sub"><%= cv.file.filename %></div>
                    </div>
                  </div>
                </div>

                <div class="col-type">
                  <span class="pill"><%= type_label %></span>
                </div>

                <div class="col-size">
                  <span class="muted size-num" data-size-text><%= size_bytes %></span>
                </div>

                <div class="col-modified">
                  <span class="muted"><%= cv.updated_at.strftime("%b %d, %Y %H:%M") %></span>
                </div>

                <div class="col-actions">
                  <div class="action-group">
                    <% if @share_link.allow_preview? && preview_url.present? %>
                      <a class="btn secondary xsmall" href="<%= preview_url %>" target="_blank" rel="noopener">Preview</a>
                    <% end %>

                    <% if @share_link.allow_download? && download_url.present? %>
                      <a class="btn secondary xsmall" href="<%= download_url %>">Download</a>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>

          </div>
        </div>
      </div>
    <% else %>
      <div class="drive-card" style="padding:16px;">
        <div class="muted">No files in this folder.</div>
      </div>
    <% end %>
  <% end %>

</div>

<style>
  .share-hero{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap: 16px;
    padding: 16px 6px 10px;
    margin-bottom: 10px;
  }
  .share-title{
    margin: 8px 0 6px;
    font-size: 28px;
    letter-spacing: -0.2px;
  }
  .share-sub{ font-size: 13px; }
  .share-hero-right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .share-badges{ display:flex; gap:8px; flex-wrap:wrap; }
  .badge{
    display:inline-flex;
    align-items:center;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    background: rgba(0,0,0,0.06);
  }
  .badge.neutral{ background: rgba(37,99,235,0.10); }
  .badge.danger{ background: rgba(185,28,28,0.12); }

  .folders-pick-list .folders-pick-header,
  .folders-pick-list .folder-pick-row{
    display:grid;
    grid-template-columns: 1fr 160px;
    gap: 12px;
    padding: 10px 14px;
    align-items:center;
    font-size: 13px;
    line-height: 1.35;
  }
  .folders-pick-list .folders-pick-header{
    font-size: 11.5px;
    font-weight: 600;
    letter-spacing: 0.02em;
    background: rgba(0,0,0,0.02);
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }
  .folder-pick-row{
    border-bottom: 1px solid rgba(0,0,0,0.06);
    transition: background 0.15s ease;
    cursor:pointer;
  }
  .folder-pick-row:hover{ background: rgba(0,0,0,0.02); }

  .folder-cell{ display:flex; align-items:center; gap:10px; min-width:0; }
  .folder-icon{ opacity:0.85; display:flex; }
  .folder-name{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .folder-sticky-bar{
    position: sticky;
    top: 0;
    z-index: 20;
    background: #fff;
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 10px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    margin-bottom: 10px;
  }
  .folder-sticky-left{ display:flex; align-items:center; gap:10px; min-width:0; }
  .folder-sticky-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

  .shared-files-list { min-width: 980px; }
  .shared-files-list .drive-header,
  .shared-files-list .drive-row{
    display:grid;
    grid-template-columns: minmax(320px, 1fr) 90px 110px 190px 220px;
    gap: 12px;
    padding: 10px 14px;
    align-items:center;
    font-size: 13px;
    line-height: 1.35;
  }
  .shared-files-list .drive-header{
    font-size: 11.5px;
    font-weight: 600;
    letter-spacing: 0.02em;
    background: rgba(0,0,0,0.02);
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }
  .shared-row{
    border-bottom: 1px solid rgba(0,0,0,0.06);
    transition: background 0.15s ease;
  }
  .shared-row:hover{ background: rgba(0,0,0,0.02); }
  .clickable-row{ cursor:pointer; }

  .file-line{ display:flex; align-items:flex-start; gap:10px; }
  .file-text{ min-width:0; }
  .file-name{ font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .file-sub{ font-size: 11.5px; opacity: 0.7; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-top:2px; }

  .size-num{ font-variant-numeric: tabular-nums; }
  .col-size{ justify-self:end; }
  .action-group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn.xsmall { padding: 5px 9px; border-radius: 10px; line-height: 1; font-size: 12px; }

  @media (max-width: 900px) {
    .share-hero{ align-items:flex-start; flex-direction:column; }
  }
</style>

<script>
  function initShareLinkShow() {
    document.querySelectorAll(".clickable-folder-row").forEach((row) => {
      row.addEventListener("click", (e) => {
        if (e.target.closest("a, button")) return;
        const url = row.getAttribute("data-open");
        if (url) window.location.href = url;
      });
    });

    function humanSize(bytes) {
      const units = ["B","KB","MB","GB","TB"];
      let b = Number(bytes || 0);
      let i = 0;
      while (b >= 1024 && i < units.length - 1) { b = b / 1024; i++; }
      return (i === 0 ? b.toFixed(0) : b.toFixed(1)) + " " + units[i];
    }
    document.querySelectorAll("[data-size-text]").forEach((el) => {
      const raw = parseInt(el.textContent || "0", 10);
      el.textContent = humanSize(raw);
    });

    document.querySelectorAll(".clickable-row").forEach((row) => {
      row.addEventListener("click", (e) => {
        if (e.target.closest(".col-actions")) return;
        const url = row.getAttribute("data-preview");
        if (url) window.open(url, "_blank", "noopener");
      });
    });

    document.querySelectorAll(".copy-btn").forEach((btn) => {
      if (btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";

      btn.addEventListener("click", async () => {
        const text = btn.getAttribute("data-copy");
        try {
          await navigator.clipboard.writeText(text);
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
        const old = btn.textContent;
        btn.textContent = "Copied";
        setTimeout(() => (btn.textContent = old), 900);
      });
    });
  }

  document.addEventListener("turbo:load", initShareLinkShow);
  document.addEventListener("DOMContentLoaded", initShareLinkShow);
</script>
