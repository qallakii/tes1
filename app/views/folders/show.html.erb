<!-- app/views/folders/show.html.erb -->
<div class="dashboard-page">

  <div class="drive-page-head">
    <div class="drive-head-left" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <% back_path = @folder.parent_id.present? ? folder_path(@folder.parent_id) : dashboard_path %>
      <%= link_to "← Back", back_path, class: "btn secondary" %>

      <div>
        <h2 style="margin-bottom:5px;"><%= @folder.name %></h2>

        <div class="muted" style="font-size:13px;">
          <%= link_to "Home", dashboard_path, class: "muted" %>
          <% @folder.ancestors.each do |anc| %>
            <span aria-hidden="true"> / </span>
            <%= link_to anc.name, folder_path(anc), class: "muted" %>
          <% end %>
          <span aria-hidden="true"> / </span>
          <span><%= @folder.name %></span>
        </div>
      </div>
    </div>

    <div class="drive-head-right" style="margin-bottom:5px;">
      <%= link_to "New Folder", new_folder_path(parent_id: @folder.id), class: "btn secondary" %>

      <button id="open-upload" class="btn primary" type="button">Upload</button>

      <div id="bulk-actions" style="display:none; margin-top:5px; align-items:center; gap:8px;">
        <button id="bulk-share" class="btn secondary" type="button">Share</button>
        <button id="bulk-download" class="btn secondary" type="button">Download</button>
        <button id="bulk-move" class="btn secondary" type="button">Move</button>
        <button id="bulk-delete" class="btn secondary" type="button">Delete</button>
      </div>
    </div>
  </div>

  <% if (@subfolders || []).any? || (@cvs || []).any? %>
    <div class="drive-card">
      <div class="drive-scroll">
        <div class="drive-list cvs-list">

          <div class="drive-header">
            <div class="col-cv-check"><input type="checkbox" id="select-all" /></div>
            <div class="col-cv-name">Name</div>
            <div class="col-cv-type">Type</div>
            <div class="col-cv-size">Size</div>
            <div class="col-cv-modified">Last modified</div>
            <div class="col-cv-actions">Actions</div>
          </div>

          <!-- ✅ FOLDERS -->
          <% (@subfolders || []).each do |sf| %>
            <div class="drive-row folder-row clickable-folder"
                 data-folder-url="<%= folder_path(sf) %>">

              <div class="col-cv-check">
                <input class="folder-check" type="checkbox" value="<%= sf.id %>" />
              </div>

              <div class="col-cv-name">
                <div class="file-line">
                  <span class="folder-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    </svg>
                  </span>

                  <div class="file-text">
                    <div class="file-name"><%= sf.name %></div>
                    <div class="file-sub">Folder</div>
                  </div>
                </div>
              </div>

              <div class="col-cv-type">
                <span class="pill">FOLDER</span>
              </div>

              <div class="col-cv-size">
                <span class="muted">—</span>
              </div>

              <div class="col-cv-modified">
                <span class="muted"><%= sf.updated_at.strftime("%b %d, %Y %H:%M") %></span>
              </div>

              <div class="col-cv-actions" onclick="event.stopPropagation();">
                <div class="kebab-wrap">
                  <button type="button" class="kebab-btn" data-kebab="folder-<%= sf.id %>">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true">
                      <circle cx="12" cy="5" r="1.8"></circle>
                      <circle cx="12" cy="12" r="1.8"></circle>
                      <circle cx="12" cy="19" r="1.8"></circle>
                    </svg>
                  </button>

                  <div class="kebab-menu" data-kebab-menu="folder-<%= sf.id %>">
                    <a class="kebab-item" href="<%= folder_path(sf) %>">Open</a>

                    <button type="button"
                            class="kebab-item folder-rename-btn"
                            data-folder-id="<%= sf.id %>"
                            data-folder-name="<%= sf.name %>">
                      Rename
                    </button>

                    <%= button_to "Delete",
                      folder_path(sf),
                      method: :delete,
                      data: { confirm: "Delete this folder and everything inside?" },
                      class: "kebab-item danger",
                      form: { class: "inline-form" } %>
                  </div>
                </div>
              </div>

            </div>
          <% end %>

          <!-- ✅ FILES -->
          <% (@cvs || []).each do |cv| %>
            <% blob = cv.file&.blob %>
            <% display_name = cv.title.presence || cv.file.filename.to_s %>
            <% ext = cv.file.filename.extension.to_s.upcase %>
            <% type_label = ext.present? ? ext : "FILE" %>
            <% size_bytes = blob&.byte_size.to_i %>

            <% preview_url = rails_blob_path(cv.file, disposition: "inline") %>
            <% download_url = rails_blob_path(cv.file, disposition: "attachment") %>

            <div class="drive-row cv-row clickable-row"
                 data-preview="<%= preview_url %>"
                 data-download="<%= download_url %>">

              <div class="col-cv-check">
                <input class="cv-check" type="checkbox" value="<%= cv.id %>" />
              </div>

              <div class="col-cv-name">
                <div class="file-line">
                  <span class="folder-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <path d="M14 2v6h6"></path>
                    </svg>
                  </span>

                  <div class="file-text">
                    <div class="file-name"><%= display_name %></div>
                    <div class="file-sub"><%= cv.file.filename %></div>
                  </div>
                </div>
              </div>

              <div class="col-cv-type">
                <span class="pill"><%= type_label %></span>
              </div>

              <div class="col-cv-size">
                <span class="muted size-num" data-size-text><%= size_bytes %></span>
              </div>

              <div class="col-cv-modified">
                <span class="muted"><%= cv.updated_at.strftime("%b %d, %Y %H:%M") %></span>
              </div>

              <div class="col-cv-actions" onclick="event.stopPropagation();">
                <div class="kebab-wrap">
                  <button type="button" class="kebab-btn" data-kebab="file-<%= cv.id %>">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true">
                      <circle cx="12" cy="5" r="1.8"></circle>
                      <circle cx="12" cy="12" r="1.8"></circle>
                      <circle cx="12" cy="19" r="1.8"></circle>
                    </svg>
                  </button>

                  <div class="kebab-menu" data-kebab-menu="file-<%= cv.id %>">
                    <a class="kebab-item" href="<%= preview_url %>" target="_blank">Preview</a>
                    <a class="kebab-item" href="<%= download_url %>">Download</a>

                    <button type="button" class="kebab-item share-one-btn" data-cv-id="<%= cv.id %>">Share</button>
                    <button type="button" class="kebab-item move-one-btn" data-cv-id="<%= cv.id %>">Move</button>

                    <%= button_to "Delete",
                      folder_cv_path(@folder, cv),
                      method: :delete,
                      data: { confirm: "Delete this file?" },
                      class: "kebab-item danger",
                      form: { class: "inline-form" } %>
                  </div>
                </div>
              </div>

            </div>
          <% end %>

        </div>
      </div>
    </div>
  <% else %>
    <p class="empty-message">This folder is empty.</p>
  <% end %>

  <!-- ✅ Bulk delete (FOLDERS + FILES) -->
  <%= form_with url: bulk_destroy_items_folder_path(@folder), method: :delete, local: true, id: "bulk-destroy-items-form" do %>
    <div id="bulk-destroy-folder-ids"></div>
    <div id="bulk-destroy-file-ids"></div>
  <% end %>

  <!-- ✅ Bulk download (FOLDERS + FILES) -->
  <%= form_with url: bulk_download_items_folder_path(@folder), method: :post, local: true, id: "bulk-download-form" do %>
    <div id="bulk-download-folder-ids"></div>
    <div id="bulk-download-file-ids"></div>
  <% end %>

  <!-- Bulk move (FOLDERS + FILES) -->
  <%= form_with url: bulk_move_items_folder_path(@folder), method: :post, local: true, id: "bulk-move-form" do %>
    <%= hidden_field_tag :target_folder_id, "", id: "move-target-folder-id" %>
    <div id="bulk-move-folder-ids"></div>
    <div id="bulk-move-file-ids"></div>
  <% end %>

  <!-- Move ONE file -->
  <%= form_with url: bulk_move_items_folder_path(@folder), method: :post, local: true, id: "move-one-form" do %>
    <%= hidden_field_tag :target_folder_id, "", id: "move-target-folder-id-one" %>
    <div id="move-one-file-id"></div>
  <% end %>

  <!-- Rename folder modal -->
  <div id="rename-folder-overlay" class="overlay" style="display:none;">
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 style="margin:0;">Rename folder</h3>
        <button type="button" id="close-rename-folder" class="btn secondary xsmall">Close</button>
      </div>

      <div style="margin-top:12px;">
        <%= form_with url: rename_folder_path(@folder), method: :patch, local: true, id: "rename-folder-form", data: { rename_prefix: folders_path } do %>
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

          <div class="muted" style="font-size:13px; margin-bottom:6px;">New name</div>

          <input id="rename-folder-input"
                 name="folder[name]"
                 type="text"
                 required
                 style="width:96%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">

          <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px;">
            <button type="button" id="cancel-rename-folder" class="btn secondary">Cancel</button>
            <button type="submit" class="btn primary">Rename</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Move Tree modal -->
  <div id="move-overlay" class="overlay" style="display:none;">
    <div class="modal-card" style="width:min(720px, 95vw);">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 style="margin:0;">Move to…</h3>
        <button type="button" id="close-move" class="btn secondary xsmall">Close</button>
      </div>

      <div class="muted" style="font-size:13px; margin-top:6px;">
        Choose a destination folder.
      </div>

      <div id="move-selected" class="muted" style="font-size:13px; margin-top:10px;">
        Selected: <span id="move-selected-name">None</span>
      </div>

      <div class="move-tree-wrap" style="margin-top:12px; border:1px solid rgba(0,0,0,0.10); border-radius:12px; padding:10px; max-height: 360px; overflow:auto;">
        <% folders = (@all_folders_for_tree || []) %>
        <% children = Hash.new { |h,k| h[k] = [] } %>
        <% folders.each { |f| children[f.parent_id] << f } %>

        <% render_node = lambda do |node, depth| %>
          <% kids = children[node.id] %>

          <div class="tree-row" data-folder-id="<%= node.id %>" data-folder-name="<%= node.name %>" style="padding-left:<%= depth * 18 %>px;">
            <button type="button" class="tree-toggle" aria-label="Toggle" style="<%= kids.any? ? '' : 'visibility:hidden;' %>">
              ▸
            </button>

            <button type="button" class="tree-pick">
              <span class="tree-icon" aria-hidden="true" style="display:inline-flex; margin-right:8px;">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                </svg>
              </span>
              <span class="tree-name"><%= node.name %></span>
            </button>
          </div>

          <% if kids.any? %>
            <div class="tree-children" style="display:none;">
              <% kids.each do |child| %>
                <%= render_node.call(child, depth + 1) %>
              <% end %>
            </div>
          <% end %>
        <% end %>

        <% (children[nil] || []).each do |root| %>
          <%= render_node.call(root, 0) %>
        <% end %>
      </div>

      <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px;">
        <button type="button" id="move-cancel" class="btn secondary">Cancel</button>
        <button type="button" id="move-confirm" class="btn primary" disabled>Move</button>
      </div>
    </div>
  </div>

  <!-- Upload modal -->
  <div id="upload-overlay" class="overlay" style="display:none;">
    <div class="modal-card" style="width:min(720px, 95vw);">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 style="margin:0;">Upload files</h3>
        <button type="button" id="close-upload" class="btn secondary xsmall">Close</button>
      </div>

      <div class="muted" style="font-size:13px; margin-top:6px;">
        Drag & drop files here, or click “Choose files”.
      </div>

      <%= form_with url: folder_cvs_path(@folder), method: :post, local: true, html: { multipart: true }, id: "upload-form" do %>
        <div id="upload-dropzone" class="upload-dropzone" style="margin-top:12px;">
          <div class="upload-dropzone-inner">
            <div style="font-weight:600;">Drop files or a folder to upload</div>
            <div class="muted" style="font-size:13px; margin-top:4px;">or</div>

            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; justify-content:center;">
              <button type="button" id="choose-files" class="btn secondary">
                Choose files
              </button>

              <button type="button" id="choose-folder" class="btn secondary">
                Choose folder
              </button>
            </div>

            <input id="upload-file-input" type="file" name="cv[files][]" multiple style="display:none;" />
            <input id="upload-folder-input" type="file" name="cv[files][]" multiple webkitdirectory directory style="display:none;" />

            <div id="upload-paths"></div>
          </div>
        </div>

        <div id="upload-file-list-wrap" style="margin-top:12px; display:none;">
          <div class="muted" style="font-size:13px; margin-bottom:6px;">Selected</div>
          <ul id="upload-file-list" style="margin:0; padding-left:18px;"></ul>
        </div>

        <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:10px;">
          <button type="button" id="cancel-upload" class="btn secondary">Cancel</button>
          <button type="submit" id="upload-submit" class="btn primary" disabled>Upload</button>
        </div>
      <% end %>

    </div>
  </div>

</div>

<style>
  .cvs-list { min-width: 980px; }
  .cvs-list .drive-header,
  .cvs-list .drive-row{
    display:grid;
    grid-template-columns: 52px minmax(320px, 1fr) 90px 110px 190px 120px;
    gap: 12px;
    padding: 10px 14px;
    align-items:center;
    font-size: 13px;
    line-height: 1.35;
  }
  .cvs-list .drive-header{
    font-size: 11.5px;
    font-weight: 600;
    letter-spacing: 0.02em;
    background: rgba(0,0,0,0.02);
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }
  .cvs-list .drive-row{ border-bottom: 1px solid rgba(0,0,0,0.06); }
  .cvs-list .drive-row:hover{ background: rgba(0,0,0,0.02); }
  .file-line{ display:flex; align-items:flex-start; gap:10px; }
  .file-text{ min-width:0; }
  .file-name{ font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .file-sub{ font-size: 11.5px; opacity: 0.7; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-top:2px; }
  .col-cv-size{ justify-self:end; }
  .size-num{ font-variant-numeric: tabular-nums; }
  .folder-check{ width:13px; height:13px; cursor:pointer; }

  .col-cv-actions{ justify-self:end; }
  .kebab-wrap{ position:relative; display:inline-block; }
  .kebab-btn{
    border: 1px solid rgba(0,0,0,0.12);
    background:#fff;
    border-radius: 12px;
    padding: 6px 8px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .kebab-menu{
    position:absolute;
    right:0;
    top: calc(100% + 8px);
    min-width: 180px;
    background:#fff;
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 12px;
    box-shadow: 0 16px 40px rgba(0,0,0,0.18);
    padding: 6px;
    display:none;
    z-index: 5000;
  }
  .kebab-item{
    width:100%;
    display:block;
    text-align:left;
    padding: 9px 10px;
    border-radius: 10px;
    border:none;
    background: transparent;
    cursor:pointer;
    font-size: 13px;
    color: inherit;
    text-decoration:none;
  }
  .kebab-item:hover{ background: rgba(0,0,0,0.06); }
  .kebab-item.danger{ color:#b91c1c; }
  .inline-form{ display:block; margin:0; }
  .inline-form button{ width:100%; }

  .overlay{
    position: fixed; inset:0;
    background: rgba(0,0,0,0.45);
    display:flex; align-items:center; justify-content:center;
    z-index: 8000;
    padding: 18px;
  }
  .modal-card{
    background:#fff;
    border-radius: 14px;
    padding: 16px;
    width: min(560px, 92vw);
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  }

  .tree-row{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 6px;
    border-radius:10px;
  }
  .tree-row:hover{ background: rgba(0,0,0,0.04); }
  .tree-toggle{
    width:28px;
    height:28px;
    border:1px solid rgba(0,0,0,0.10);
    background:#fff;
    border-radius:10px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    line-height:1;
  }
  .tree-pick{
    border:none;
    background:transparent;
    cursor:pointer;
    display:flex;
    align-items:center;
    min-width:0;
    padding:6px 8px;
    border-radius:10px;
  }
  .tree-pick:hover{ background: rgba(0,0,0,0.06); }
  .tree-name{
    font-weight:600;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 480px;
  }
  .tree-row.selected{
    background: rgba(0,0,0,0.06);
    outline: 1px solid rgba(0,0,0,0.10);
  }

  .upload-dropzone{
    border: 2px dashed rgba(0,0,0,0.18);
    border-radius: 14px;
    padding: 18px;
    background: rgba(0,0,0,0.02);
    transition: background 120ms ease, border-color 120ms ease;
  }
  .upload-dropzone.dragover{
    background: rgba(0,0,0,0.05);
    border-color: rgba(0,0,0,0.28);
  }
  .upload-dropzone-inner{
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:2px;
    padding: 10px;
  }
</style>

<script>
  function initFolderShowPage() {
    if (window.__folderShowInitDone) return;
    window.__folderShowInitDone = true;

    function humanSize(bytes) {
      const units = ["B","KB","MB","GB","TB"];
      let b = Number(bytes || 0);
      let i = 0;
      while (b >= 1024 && i < units.length - 1) { b = b / 1024; i++; }
      return (i === 0 ? b.toFixed(0) : b.toFixed(1)) + " " + units[i];
    }

    // format sizes
    document.querySelectorAll("[data-size-text]").forEach((el) => {
      const raw = parseInt(el.textContent || "0", 10);
      el.textContent = humanSize(raw);
    });

    // kebab menus
    function closeAllMenus() {
      document.querySelectorAll(".kebab-menu").forEach((m) => m.style.display = "none");
    }
    document.querySelectorAll("[data-kebab]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const key = btn.getAttribute("data-kebab");
        const menu = document.querySelector('[data-kebab-menu="' + key + '"]');
        if (!menu) return;
        const isOpen = menu.style.display === "block";
        closeAllMenus();
        menu.style.display = isOpen ? "none" : "block";
      });
    });
    document.addEventListener("click", () => closeAllMenus());
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeAllMenus(); });

    // selection (folders + files)
    const selectAll = document.getElementById("select-all");
    const fileChecks = Array.from(document.querySelectorAll(".cv-check"));
    const folderChecks = Array.from(document.querySelectorAll(".folder-check"));

    const bulkBar = document.getElementById("bulk-actions");
    const openUploadBtn = document.getElementById("open-upload");

    // Prevent checkbox clicks from triggering row click logic (prevents double-toggle)
    folderChecks.forEach(cb => cb.addEventListener("click", (e) => e.stopPropagation()));
    fileChecks.forEach(cb => cb.addEventListener("click", (e) => e.stopPropagation()));

    function selectedFileIds() {
      return fileChecks.filter(c => c.checked).map(c => c.value);
    }
    function selectedFolderIds() {
      return folderChecks.filter(c => c.checked).map(c => c.value).filter(Boolean);
    }

    function updateBulk() {
      const any = selectedFileIds().length > 0 || selectedFolderIds().length > 0;
      if (bulkBar) bulkBar.style.display = any ? "flex" : "none";
      if (openUploadBtn) openUploadBtn.style.display = any ? "none" : "";

      if (selectAll) {
        const all = [...fileChecks, ...folderChecks];
        selectAll.checked = all.length > 0 && all.every(c => c.checked);
      }
    }

    if (selectAll) {
      selectAll.addEventListener("change", () => {
        const val = selectAll.checked;
        fileChecks.forEach(c => (c.checked = val));
        folderChecks.forEach(c => (c.checked = val));
        updateBulk();
      });
    }

    fileChecks.forEach(c => c.addEventListener("change", updateBulk));
    folderChecks.forEach(c => c.addEventListener("change", updateBulk));
    updateBulk();

    // Folder rows: single click = select, double click = open
    const folderRows = Array.from(document.querySelectorAll(".clickable-folder"));
    const CLICK_DELAY = 220;
    let folderClickTimer = null;

    folderRows.forEach((row) => {
      const checkbox = row.querySelector(".folder-check");
      const url = row.getAttribute("data-folder-url");

      row.addEventListener("click", (e) => {
        if (e.target.closest(".kebab-wrap")) return;
        if (e.target.closest(".col-cv-actions")) return;

        clearTimeout(folderClickTimer);
        folderClickTimer = setTimeout(() => {
          if (!checkbox) return;
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event("change", { bubbles: true }));
        }, CLICK_DELAY);
      });

      row.addEventListener("dblclick", (e) => {
        if (e.target.closest(".kebab-wrap")) return;
        if (e.target.closest(".col-cv-actions")) return;

        clearTimeout(folderClickTimer);
        if (url) window.location = url;
      });
    });

    // File rows: single click = select, double click = preview
    let fileClickTimer = null;
    document.querySelectorAll(".cv-row.clickable-row").forEach((row) => {
      const checkbox = row.querySelector(".cv-check");
      if (!checkbox) return;

      row.addEventListener("click", (e) => {
        if (e.target.closest(".kebab-wrap")) return;
        if (e.target.closest(".col-cv-actions")) return;

        clearTimeout(fileClickTimer);
        fileClickTimer = setTimeout(() => {
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event("change", { bubbles: true }));
        }, CLICK_DELAY);
      });

      row.addEventListener("dblclick", (e) => {
        if (e.target.closest(".kebab-wrap")) return;
        if (e.target.closest(".col-cv-actions")) return;

        clearTimeout(fileClickTimer);
        const url = row.getAttribute("data-preview");
        if (url) window.open(url, "_blank", "noopener");
      });
    });

    // Rename folder modal
    const renameOverlay = document.getElementById("rename-folder-overlay");
    const closeRename = document.getElementById("close-rename-folder");
    const cancelRename = document.getElementById("cancel-rename-folder");
    const renameInput = document.getElementById("rename-folder-input");

    function openRenameModal(folderId, folderName) {
      const form = document.getElementById("rename-folder-form");
      if (!renameOverlay || !renameInput || !form) return;

      renameInput.value = folderName || "";
      const prefix = (form.dataset.renamePrefix || "").replace(/\/$/, "");
      form.action = prefix + "/" + folderId + "/rename";

      renameOverlay.style.display = "flex";
      setTimeout(() => renameInput.focus(), 20);
      setTimeout(() => renameInput.select(), 30);
    }
    function closeRenameModal() {
      if (!renameOverlay) return;
      renameOverlay.style.display = "none";
    }

    document.querySelectorAll(".folder-rename-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        closeAllMenus();
        const id = btn.getAttribute("data-folder-id");
        const name = btn.getAttribute("data-folder-name");
        if (id) openRenameModal(id, name);
      });
    });

    if (closeRename) closeRename.addEventListener("click", closeRenameModal);
    if (cancelRename) cancelRename.addEventListener("click", closeRenameModal);
    if (renameOverlay) renameOverlay.addEventListener("click", (e) => {
      if (e.target === renameOverlay) closeRenameModal();
    });

    // ✅ Bulk delete (FOLDERS + FILES)
    const bulkDelete = document.getElementById("bulk-delete");
    const destroyForm = document.getElementById("bulk-destroy-items-form");
    const destroyFolderIds = document.getElementById("bulk-destroy-folder-ids");
    const destroyFileIds = document.getElementById("bulk-destroy-file-ids");

    if (bulkDelete && destroyForm && destroyFolderIds && destroyFileIds) {
      bulkDelete.addEventListener("click", () => {
        const fids = selectedFolderIds();
        const ids = selectedFileIds();

        if (fids.length === 0 && ids.length === 0) return;
        if (!confirm(`Delete ${fids.length} folder(s) and ${ids.length} file(s)? This will delete subfolders too.`)) return;

        destroyFolderIds.innerHTML = "";
        destroyFileIds.innerHTML = "";

        fids.forEach((id) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "folder_ids[]";
          input.value = id;
          destroyFolderIds.appendChild(input);
        });

        ids.forEach((id) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "cv_ids[]";
          input.value = id;
          destroyFileIds.appendChild(input);
        });

        destroyForm.submit();
      });
    }

    // ✅ Bulk download (FOLDERS + FILES) => zip
    const bulkDownloadBtn = document.getElementById("bulk-download");
    const bulkDownloadForm = document.getElementById("bulk-download-form");
    const bulkDownloadFolderIds = document.getElementById("bulk-download-folder-ids");
    const bulkDownloadFileIds = document.getElementById("bulk-download-file-ids");

    if (bulkDownloadBtn && bulkDownloadForm && bulkDownloadFolderIds && bulkDownloadFileIds) {
      bulkDownloadBtn.addEventListener("click", () => {
        const fids = selectedFolderIds();
        const ids = selectedFileIds();

        if (fids.length === 0 && ids.length === 0) return;

        bulkDownloadFolderIds.innerHTML = "";
        bulkDownloadFileIds.innerHTML = "";

        fids.forEach((id) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "folder_ids[]";
          input.value = id;
          bulkDownloadFolderIds.appendChild(input);
        });

        ids.forEach((id) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "cv_ids[]";
          input.value = id;
          bulkDownloadFileIds.appendChild(input);
        });

        bulkDownloadForm.submit();
      });
    }

    // ===== Bulk Share (folders OR files) =====
    const bulkShare = document.getElementById("bulk-share");
    function csrfToken() {
      const meta = document.querySelector('meta[name="csrf-token"]');
      return meta ? meta.getAttribute("content") : "";
    }
    function postForm(action, fields) {
      const form = document.createElement("form");
      form.method = "post";
      form.action = action;

      const token = csrfToken();
      if (token) {
        const t = document.createElement("input");
        t.type = "hidden";
        t.name = "authenticity_token";
        t.value = token;
        form.appendChild(t);
      }

      fields.forEach(({ name, value }) => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = name;
        input.value = value;
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
      form.remove();
    }

    if (bulkShare) {
      bulkShare.addEventListener("click", () => {
        const fids = selectedFolderIds();
        const ids = selectedFileIds();

        if (fids.length === 0 && ids.length === 0) return;

        if (fids.length > 0 && ids.length > 0) {
          alert("Please share either folders OR files (not both at the same time).");
          return;
        }

        if (fids.length > 0) {
          const fields = fids.map((id) => ({ name: "folder_ids[]", value: id }));
          postForm("/share_links/bulk_create", fields);
          return;
        }

        if (ids.length > 0) {
          const fields = ids.map((id) => ({ name: "cv_ids[]", value: id }));
          postForm("/share_links/bulk_create_files", fields);
        }
      });
    }

    // ===== Move modal logic (unchanged) =====
    const moveOverlay = document.getElementById("move-overlay");
    const closeMove = document.getElementById("close-move");
    const moveCancel = document.getElementById("move-cancel");
    const moveConfirm = document.getElementById("move-confirm");
    const moveSelectedName = document.getElementById("move-selected-name");

    const bulkMoveBtn = document.getElementById("bulk-move");
    const bulkMoveForm = document.getElementById("bulk-move-form");
    const bulkMoveFolderIds = document.getElementById("bulk-move-folder-ids");
    const bulkMoveFileIds = document.getElementById("bulk-move-file-ids");
    const moveTargetBulk = document.getElementById("move-target-folder-id");

    const moveOneForm = document.getElementById("move-one-form");
    const moveOneFileId = document.getElementById("move-one-file-id");
    const moveTargetOne = document.getElementById("move-target-folder-id-one");

    let pendingMoveMode = null; // "bulk" | "one"
    let pendingMoveCvId = null;
    let selectedTargetFolderId = null;
    let selectedTargetFolderName = null;

    function openMoveModal(mode, cvId = null) {
      pendingMoveMode = mode;
      pendingMoveCvId = cvId;

      selectedTargetFolderId = null;
      selectedTargetFolderName = null;

      document.querySelectorAll(".tree-row.selected").forEach((r) => r.classList.remove("selected"));
      if (moveSelectedName) moveSelectedName.textContent = "None";
      if (moveConfirm) moveConfirm.disabled = true;

      if (moveOverlay) moveOverlay.style.display = "flex";
    }

    function closeMoveModal() {
      if (moveOverlay) moveOverlay.style.display = "none";
      pendingMoveMode = null;
      pendingMoveCvId = null;
      selectedTargetFolderId = null;
      selectedTargetFolderName = null;
    }

    if (bulkMoveBtn) {
      bulkMoveBtn.addEventListener("click", () => {
        const fids = selectedFolderIds();
        const ids = selectedFileIds();
        if ((!fids || fids.length === 0) && (!ids || ids.length === 0)) return;
        openMoveModal("bulk");
      });
    }

    document.querySelectorAll(".move-one-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        closeAllMenus();
        const id = btn.getAttribute("data-cv-id");
        if (!id) return;
        openMoveModal("one", id);
      });
    });

    document.querySelectorAll(".tree-toggle").forEach((toggle) => {
      toggle.addEventListener("click", (e) => {
        e.stopPropagation();
        const row = toggle.closest(".tree-row");
        if (!row) return;

        const children = row.nextElementSibling;
        if (!children || !children.classList.contains("tree-children")) return;

        const isOpen = children.style.display === "block";
        children.style.display = isOpen ? "none" : "block";
        toggle.textContent = isOpen ? "▸" : "▾";
      });
    });

    document.querySelectorAll(".tree-row .tree-pick").forEach((pickBtn) => {
      pickBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const row = pickBtn.closest(".tree-row");
        if (!row) return;

        document.querySelectorAll(".tree-row.selected").forEach((r) => r.classList.remove("selected"));
        row.classList.add("selected");

        selectedTargetFolderId = row.getAttribute("data-folder-id");
        selectedTargetFolderName = row.getAttribute("data-folder-name");

        if (moveSelectedName) moveSelectedName.textContent = selectedTargetFolderName || "Selected";
        if (moveConfirm) moveConfirm.disabled = !selectedTargetFolderId;
      });
    });

    if (moveConfirm) {
      moveConfirm.addEventListener("click", () => {
        if (!selectedTargetFolderId) return;

        if (pendingMoveMode === "bulk") {
          const fids = selectedFolderIds();
          const ids = selectedFileIds();
          if ((!fids || fids.length === 0) && (!ids || ids.length === 0)) return;

          if (bulkMoveFolderIds) bulkMoveFolderIds.innerHTML = "";
          if (bulkMoveFileIds) bulkMoveFileIds.innerHTML = "";

          (fids || []).forEach((id) => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "folder_ids[]";
            input.value = id;
            bulkMoveFolderIds.appendChild(input);
          });

          (ids || []).forEach((id) => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "cv_ids[]";
            input.value = id;
            bulkMoveFileIds.appendChild(input);
          });

          if (moveTargetBulk) moveTargetBulk.value = selectedTargetFolderId;

          closeMoveModal();
          if (bulkMoveForm) bulkMoveForm.submit();
          return;
        }

        if (pendingMoveMode === "one") {
          if (!pendingMoveCvId) return;

          if (moveOneFileId) {
            moveOneFileId.innerHTML = "";
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "cv_ids[]";
            input.value = pendingMoveCvId;
            moveOneFileId.appendChild(input);
          }

          if (moveTargetOne) moveTargetOne.value = selectedTargetFolderId;

          closeMoveModal();
          if (moveOneForm) moveOneForm.submit();
        }
      });
    }

    if (closeMove) closeMove.addEventListener("click", closeMoveModal);
    if (moveCancel) moveCancel.addEventListener("click", closeMoveModal);
    if (moveOverlay) moveOverlay.addEventListener("click", (e) => {
      if (e.target === moveOverlay) closeMoveModal();
    });

    // ===== Upload modal =====
    const uploadOverlay = document.getElementById("upload-overlay");
    const closeUploadBtn = document.getElementById("close-upload");
    const cancelUploadBtn = document.getElementById("cancel-upload");

    const chooseFilesBtn = document.getElementById("choose-files");
    const chooseFolderBtn = document.getElementById("choose-folder");

    const filesInput = document.getElementById("upload-file-input");
    const folderInput = document.getElementById("upload-folder-input");
    const dropzone = document.getElementById("upload-dropzone");

    const pathsWrap = document.getElementById("upload-paths");
    const listWrap = document.getElementById("upload-file-list-wrap");
    const fileList = document.getElementById("upload-file-list");
    const uploadSubmit = document.getElementById("upload-submit");
    const uploadForm = document.getElementById("upload-form");

    function openUploadModal() {
      if (!uploadOverlay) return;
      uploadOverlay.style.display = "flex";
    }

    function clearPaths() {
      if (pathsWrap) pathsWrap.innerHTML = "";
    }

    function resetUploadUI() {
      if (filesInput) filesInput.value = "";
      if (folderInput) folderInput.value = "";
      clearPaths();

      if (fileList) fileList.innerHTML = "";
      if (listWrap) listWrap.style.display = "none";
      if (uploadSubmit) {
        uploadSubmit.disabled = true;
        uploadSubmit.textContent = "Upload";
      }
    }

    function closeUploadModal() {
      if (!uploadOverlay) return;
      uploadOverlay.style.display = "none";
      resetUploadUI();
    }

    function activeSelectedFiles() {
      const folderFiles = folderInput && folderInput.files ? Array.from(folderInput.files) : [];
      const normalFiles = filesInput && filesInput.files ? Array.from(filesInput.files) : [];
      return folderFiles.length > 0 ? folderFiles : normalFiles;
    }

    function buildPathsFor(files) {
      clearPaths();
      if (!pathsWrap) return;

      files.forEach((f) => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "cv[paths][]";
        input.value = f.webkitRelativePath || "";
        pathsWrap.appendChild(input);
      });
    }

    function renderSelectedFiles() {
      const files = activeSelectedFiles();
      if (!fileList || !listWrap || !uploadSubmit) return;

      if (files.length === 0) {
        fileList.innerHTML = "";
        listWrap.style.display = "none";
        uploadSubmit.disabled = true;
        return;
      }

      buildPathsFor(files);

      fileList.innerHTML = "";
      files.forEach((f) => {
        const li = document.createElement("li");
        const label = f.webkitRelativePath && f.webkitRelativePath.length > 0 ? f.webkitRelativePath : f.name;
        li.textContent = `${label} (${humanSize(f.size)})`;
        fileList.appendChild(li);
      });

      listWrap.style.display = "block";
      uploadSubmit.disabled = false;
    }

    if (openUploadBtn) openUploadBtn.addEventListener("click", openUploadModal);
    if (closeUploadBtn) closeUploadBtn.addEventListener("click", closeUploadModal);
    if (cancelUploadBtn) cancelUploadBtn.addEventListener("click", closeUploadModal);

    if (uploadOverlay) {
      uploadOverlay.addEventListener("click", (e) => {
        if (e.target === uploadOverlay) closeUploadModal();
      });
    }

    if (chooseFilesBtn && filesInput) {
      chooseFilesBtn.addEventListener("click", () => {
        if (folderInput) folderInput.value = "";
        clearPaths();
        filesInput.click();
      });
    }

    if (chooseFolderBtn && folderInput) {
      chooseFolderBtn.addEventListener("click", () => {
        if (filesInput) filesInput.value = "";
        clearPaths();
        folderInput.click();
      });
    }

    if (filesInput) filesInput.addEventListener("change", () => {
      if (folderInput) folderInput.value = "";
      renderSelectedFiles();
    });

    if (folderInput) folderInput.addEventListener("change", () => {
      if (filesInput) filesInput.value = "";
      renderSelectedFiles();
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    if (dropzone) {
      ["dragenter","dragover","dragleave","drop"].forEach((ev) => {
        dropzone.addEventListener(ev, preventDefaults, false);
      });

      ["dragenter","dragover"].forEach((ev) => {
        dropzone.addEventListener(ev, () => dropzone.classList.add("dragover"));
      });

      ["dragleave","drop"].forEach((ev) => {
        dropzone.addEventListener(ev, () => dropzone.classList.remove("dragover"));
      });

      dropzone.addEventListener("drop", (e) => {
        const dt = e.dataTransfer;
        const files = dt ? Array.from(dt.files || []) : [];
        if (files.length === 0) return;

        if (folderInput) folderInput.value = "";
        if (filesInput) {
          try { filesInput.files = dt.files; } catch (_) {}
        }
        renderSelectedFiles();
      });
    }

    if (uploadForm && uploadSubmit) {
      uploadForm.addEventListener("submit", () => {
        uploadSubmit.disabled = true;
        uploadSubmit.textContent = "Uploading...";
      });
    }
  }

  document.addEventListener("turbo:load", () => {
    window.__folderShowInitDone = false;
    initFolderShowPage();
  });
  document.addEventListener("DOMContentLoaded", () => initFolderShowPage());
</script>
