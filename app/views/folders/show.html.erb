<div class="dashboard-page folder-show-wide">

  <div class="breadcrumb-bar">
    <button class="btn secondary" onclick="window.history.back()">← Back</button>
    <span><%= @folder.name %></span>
  </div>

  <h1><%= @folder.name %></h1>

  <!-- Top bar -->
  <div class="drive-topbar">
    <div class="drive-search">
      <input id="drive-search" type="text" placeholder="Search files…" autocomplete="off" />
    </div>

    <div class="drive-controls">
      <select id="drive-sort" class="drive-sort">
        <option value="name_asc">Sort: Name (A–Z)</option>
        <option value="name_desc">Sort: Name (Z–A)</option>
        <option value="updated_desc" selected>Sort: Last modified (newest)</option>
        <option value="updated_asc">Sort: Last modified (oldest)</option>
        <option value="size_desc">Sort: Size (largest)</option>
        <option value="size_asc">Sort: Size (smallest)</option>
      </select>

      <button id="open-upload" type="button" class="btn primary">Upload CV</button>
    </div>
  </div>

  <!-- Bulk bar -->
  <div id="bulk-bar" class="bulk-bar" style="display:none;">
    <div class="bulk-left">
      <strong><span id="selected-count">0</span></strong> selected
    </div>
    <div class="bulk-right">
      <button id="bulk-delete" type="button" class="btn secondary xsmall">Delete selected</button>
      <button id="bulk-clear" type="button" class="btn secondary xsmall">Clear</button>
    </div>
  </div>

  <% if @cvs.any? %>
    <div class="drive-card">
      <div class="drive-scroll">
        <div class="drive-list">

          <div class="drive-header">
            <div class="col-check"><input id="select-all" type="checkbox" /></div>
            <div class="col-name">Name</div>
            <div class="col-type">Type</div>
            <div class="col-size">Size</div>
            <div class="col-modified">Last modified</div>
            <div class="col-actions">Actions</div>
          </div>

          <% @cvs.each do |cv| %>
            <% blob = cv.file&.blob %>
            <% display_name = cv.title.presence || cv.file.filename.to_s %>
            <% ext = cv.file.filename.extension.to_s.upcase %>
            <% type_label = ext.present? ? ext : "PDF" %>
            <% size_bytes = blob&.byte_size.to_i %>

            <div class="drive-row"
                 data-id="<%= cv.id %>"
                 data-name="<%= display_name.to_s.downcase %>"
                 data-updated="<%= cv.updated_at.to_i %>"
                 data-size="<%= size_bytes %>"
                 data-type="<%= type_label.to_s.downcase %>">

              <div class="col-check">
                <input class="row-check" type="checkbox" data-row-id="<%= cv.id %>">
              </div>

              <div class="col-name">
                <div class="file-line">
                  <span class="file-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <path d="M14 2v6h6"/>
                    </svg>
                  </span>

                  <div class="file-text">
                    <div class="file-name"><%= display_name %></div>
                    <div class="file-sub"><%= cv.file.filename %></div>
                  </div>
                </div>

                <div id="rename-form-<%= cv.id %>" class="rename-wrap" style="display:none;">
                  <%= form_with model: [@folder, cv], method: :patch, local: true do |f| %>
                    <div class="rename-row">
                      <%= f.text_field :title, value: cv.title, placeholder: "New name", class: "rename-input" %>
                      <%= f.submit "Save", class: "btn primary xsmall" %>
                      <button type="button" class="btn secondary xsmall" data-rename-cancel="<%= cv.id %>">Cancel</button>
                    </div>
                  <% end %>
                </div>
              </div>

              <div class="col-type">
                <span class="pill"><%= type_label %></span>
              </div>

              <div class="col-size">
                <span class="muted size-num" data-size-text="<%= cv.id %>"><%= size_bytes %></span>
              </div>

              <div class="col-modified">
                <span class="muted"><%= cv.updated_at.strftime("%b %d, %Y %H:%M") %></span>
              </div>

              <div class="col-actions">
                <div class="action-group">
                  <%= link_to "Preview",
                    rails_blob_path(cv.file, disposition: "inline"),
                    target: "_blank",
                    class: "btn secondary xsmall" %>

                  <%= link_to "Download",
                    rails_blob_path(cv.file, disposition: "attachment"),
                    class: "btn secondary xsmall" %>

                  <button type="button"
                    class="btn secondary xsmall"
                    data-rename-toggle="<%= cv.id %>">
                    Rename
                  </button>

                  <%= button_to "Delete",
                    folder_cv_path(@folder, cv),
                    method: :delete,
                    data: { confirm: "Are you sure?" },
                    class: "btn secondary xsmall",
                    form: { class: "inline-form" } %>
                </div>
              </div>

            </div>
          <% end %>

        </div>
      </div>
    </div>
  <% else %>
    <p class="empty-message">
      No files yet.
      <button id="open-upload-inline" type="button" class="btn primary">Upload one</button>
    </p>
  <% end %>

</div>

<style>
  /* ✅ Make THIS page wider without changing the rest of the site */
  .folder-show-wide{
    max-width: 1400px;               /* increase container width */
    width: calc(100% - 64px);        /* smaller left/right margins */
    margin-left: auto;
    margin-right: auto;
  }
  @media (max-width: 900px){
    .folder-show-wide{
      width: calc(100% - 24px);      /* tighter margins on mobile */
    }
  }

  .inline-form { display:inline-block; margin:0; }
  .btn.xsmall { padding: 5px 9px; border-radius: 10px; line-height: 1; font-size: 12px; }

  .drive-topbar { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin: 10px 0 16px 0; }
  .drive-search input {
    width: min(520px, 92vw);
    padding: 9px 11px;
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 12px;
    outline: none;
    font-size: 13px;
  }
  .drive-controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .drive-sort {
    padding: 9px 11px;
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 12px;
    background: #fff;
    font-size: 13px;
  }

  .bulk-bar {
    margin: 10px 0 14px 0;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(0,0,0,0.02);
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
    font-size: 13px;
  }
  .bulk-right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .drive-card {
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    background: #fff;
    overflow: hidden;
  }
  .drive-scroll { overflow-x: auto; overflow-y: hidden; }

  .drive-list { min-width: 980px; }
  .drive-header, .drive-row {
    display: grid;
    grid-template-columns: 42px minmax(280px, 1fr) 90px 110px 190px 420px;
    gap: 12px;
    padding: 10px 14px;
    align-items: center;
    font-size: 13px;
    line-height: 1.35;
  }
  .drive-header {
    font-size: 11.5px;
    font-weight: 600;
    letter-spacing: 0.02em;
    background: rgba(0,0,0,0.02);
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }
  .drive-row { border-bottom: 1px solid rgba(0,0,0,0.06); }
  .drive-row:hover { background: rgba(0,0,0,0.02); }

  .file-line { display:flex; align-items:flex-start; gap:10px; }
  .file-icon { margin-top:2px; opacity:0.85; flex:0 0 auto; }
  .file-text { min-width:0; }
  .file-name { font-weight: 600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .file-sub { font-size: 11.5px; opacity:0.7; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-top:2px; }

  .muted { opacity: 0.75; font-size: 12px; }
  .size-num { font-variant-numeric: tabular-nums; }
  .col-size { justify-self: end; }

  .pill {
    display:inline-flex; align-items:center; justify-content:center;
    padding: 5px 9px;
    border-radius: 999px;
    font-size: 11.5px;
    border: 1px solid rgba(0,0,0,0.10);
    background: rgba(0,0,0,0.02);
    white-space: nowrap;
  }

  .action-group { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; padding-left: 6px; }

  .rename-wrap { margin-top: 10px; }
  .rename-row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .rename-input {
    min-width: 240px;
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 10px;
    font-size: 13px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Human readable sizes
    function humanSize(bytes) {
      const units = ["B","KB","MB","GB","TB"];
      let b = Number(bytes || 0);
      let i = 0;
      while (b >= 1024 && i < units.length - 1) { b = b / 1024; i++; }
      return (i === 0 ? b.toFixed(0) : b.toFixed(1)) + " " + units[i];
    }
    document.querySelectorAll("[data-size-text]").forEach((el) => {
      const raw = parseInt(el.textContent || "0", 10);
      el.textContent = humanSize(raw);
    });

    // Rename toggles
    document.querySelectorAll("[data-rename-toggle]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-rename-toggle");
        const el = document.getElementById(`rename-form-${id}`);
        if (el) el.style.display = "block";
      });
    });
    document.querySelectorAll("[data-rename-cancel]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-rename-cancel");
        const el = document.getElementById(`rename-form-${id}`);
        if (el) el.style.display = "none";
      });
    });
  });
</script>
