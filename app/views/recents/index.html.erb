<div class="dashboard-page">

  <div class="drive-page-head">
    <div class="drive-head-left">
      <h1 style="margin:0;">Recents</h1>
      <div class="muted" style="margin-top:4px;">Recently modified files</div>
    </div>

    <div class="drive-head-right">
      <input id="recent-search" class="drive-input" type="text" placeholder="Search recents…" autocomplete="off" />
    </div>
  </div>

  <% if @recent_cvs.any? %>
    <div class="drive-card">
      <div class="drive-scroll">
        <div class="drive-list recents-list">

          <div class="drive-header">
            <div class="col-name">Name</div>
            <div class="col-type">Type</div>
            <div class="col-size">Size</div>
            <div class="col-location">Location</div>
            <div class="col-modified">Last modified</div>
            <div class="col-actions">Actions</div>
          </div>

          <% @recent_cvs.each do |cv| %>
            <% blob = cv.file&.blob %>
            <% display_name = cv.title.presence || cv.file.filename.to_s %>
            <% ext = cv.file.filename.extension.to_s.upcase %>
            <% type_label = ext.present? ? ext : "PDF" %>
            <% size_bytes = blob&.byte_size.to_i %>
            <% folder = cv.folder %>

            <div class="drive-row recent-row"
                 data-name="<%= display_name.to_s.downcase %>"
                 data-type="<%= type_label.to_s.downcase %>">

              <div class="col-name">
                <div class="file-line">
                  <span class="file-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <path d="M14 2v6h6"/>
                    </svg>
                  </span>

                  <div class="file-text">
                    <div class="file-name"><%= display_name %></div>
                    <div class="file-sub"><%= cv.file.filename %></div>
                  </div>
                </div>
              </div>

              <div class="col-type">
                <span class="pill"><%= type_label %></span>
              </div>

              <div class="col-size">
                <span class="muted size-num" data-size-text><%= size_bytes %></span>
              </div>

              <div class="col-location">
                <% if folder.present? %>
                  <%= link_to folder.name, folder_path(folder), class: "location-link" %>
                <% else %>
                  <span class="muted">—</span>
                <% end %>
              </div>

              <div class="col-modified">
                <span class="muted"><%= cv.updated_at.strftime("%b %d, %Y %H:%M") %></span>
              </div>

              <div class="col-actions">
                <div class="action-group">
                  <%= link_to "Preview",
                    rails_blob_path(cv.file, disposition: "inline"),
                    target: "_blank",
                    class: "btn secondary xsmall" %>

                  <%= link_to "Download",
                    rails_blob_path(cv.file, disposition: "attachment"),
                    class: "btn secondary xsmall" %>

                  <% if folder.present? %>
                    <%= link_to "Open folder",
                      folder_path(folder),
                      class: "btn secondary xsmall" %>
                  <% end %>
                </div>
              </div>

            </div>
          <% end %>

        </div>
      </div>
    </div>

    <div id="recent-no-results" class="no-results" style="display:none;">
      No recent files match your search.
    </div>

  <% else %>
    <p class="empty-message">Nothing recent yet.</p>
  <% end %>

</div>

<style>
  .drive-page-head{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin: 8px 0 16px 0;
  }
  .drive-head-right{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .drive-input{
    width: min(520px, 74vw);
    padding: 9px 11px;
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 12px;
    outline: none;
    font-size: 13px;
    background:#fff;
  }

  .drive-scroll { overflow-x: auto; overflow-y: hidden; }

  .recents-list { min-width: 980px; }

  .recents-list .drive-header,
  .recents-list .drive-row{
    display:grid;
    grid-template-columns: minmax(240px, 1fr) 50px 65px 145px 110px 244px;
    gap: 12px;
    padding: 10px 14px;
    align-items:center;
    font-size: 13px;
    line-height: 1.35;
  }

  .recents-list .drive-header{
    font-size: 11.5px;
    font-weight: 600;
    letter-spacing: 0.02em;
    background: rgba(0,0,0,0.02);
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }
  .recents-list .drive-row{
    border-bottom: 1px solid rgba(0,0,0,0.06);
  }
  .recents-list .drive-row:hover{ background: rgba(0,0,0,0.02); }

  .file-line { display:flex; align-items:flex-start; gap:10px; }
  .file-icon { margin-top:2px; opacity:0.85; flex:0 0 auto; }
  .file-text { min-width:0; }
  .file-name { font-weight: 600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .file-sub  { font-size: 11.5px; opacity:0.7; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-top:2px; }

  .muted { opacity: 0.75; font-size: 12px; }
  .size-num { font-variant-numeric: tabular-nums; }
  .col-size { justify-self: end; }

  .pill {
    display:inline-flex; align-items:center; justify-content:center;
    padding: 5px 9px;
    border-radius: 999px;
    font-size: 11.5px;
    border: 1px solid rgba(0,0,0,0.10);
    background: rgba(0,0,0,0.02);
    white-space: nowrap;
  }

  .location-link{
    color: #c8102e;
    font-weight: 500;
  }
  .location-link:hover{ text-decoration: underline; }

  .action-group{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }

  .btn.xsmall { padding: 5px 9px; border-radius: 10px; line-height: 1; font-size: 12px; }

  .no-results {
    padding: 14px;
    margin-top: 10px;
    border-radius: 12px;
    background: rgba(0,0,0,0.02);
    border: 1px solid rgba(0,0,0,0.06);
    font-size: 13px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    function humanSize(bytes) {
      const units = ["B","KB","MB","GB","TB"];
      let b = Number(bytes || 0);
      let i = 0;
      while (b >= 1024 && i < units.length - 1) { b = b / 1024; i++; }
      return (i === 0 ? b.toFixed(0) : b.toFixed(1)) + " " + units[i];
    }
    document.querySelectorAll("[data-size-text]").forEach((el) => {
      const raw = parseInt(el.textContent || "0", 10);
      el.textContent = humanSize(raw);
    });

    const search = document.getElementById("recent-search");
    const rows = Array.from(document.querySelectorAll(".recent-row"));
    const noResults = document.getElementById("recent-no-results");

    function apply() {
      const q = (search?.value || "").trim().toLowerCase();
      let visible = 0;

      rows.forEach((row) => {
        const name = row.getAttribute("data-name") || "";
        const type = row.getAttribute("data-type") || "";
        const match = !q || name.includes(q) || type.includes(q);
        row.style.display = match ? "" : "none";
        if (match) visible++;
      });

      if (noResults) noResults.style.display = (q && visible === 0) ? "block" : "none";
    }

    if (search) search.addEventListener("input", apply);
    apply();
  });
</script>
